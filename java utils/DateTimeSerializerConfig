@Configuration
public class DateTimeSerializerConfig {

    private static final List<String> DATE_PATTERNS = Arrays.asList(
            "yyyy-MM-dd'T'HH:mm:ss.SSS'Z'",
            "yyyy-MM-dd HH:mm:ss",
            "yyyy-MM-dd'T'HH:mm:ss",
            "yyyy-MM-dd",
            "H:m:s"
    );

    // 自定义反序列化器
    public static class CustomLocalDateTimeDeserializer extends LocalDateTimeDeserializer {
        public CustomLocalDateTimeDeserializer() {
            super(DateTimeFormatter.ofPattern(DATE_PATTERNS.get(0)));
        }

        @Override
        public LocalDateTime deserialize(JsonParser parser, DeserializationContext context)
                throws IOException {
            String dateString = parser.getText().trim();

            if(dateString.isEmpty()) {
                return null;
            }

            // 尝试所有支持的格式
            for (String pattern : DATE_PATTERNS) {
                try {
                    switch (pattern) {
                        case "yyyy-MM-dd" -> {
                            return LocalDateTime.of(
                                    LocalDate.parse(dateString, DateTimeFormatter.ofPattern(pattern)),
                                    LocalTime.MIDNIGHT
                            );
                        }
                        case "H:m:s" -> {
                            LocalTime time = LocalTime.parse(dateString, DateTimeFormatter.ofPattern("H:m:s"));
                            return LocalDateTime.of(LocalDate.now(), time);
                        }
                        case "yyyy-MM-dd'T'HH:mm:ss.SSS'Z'" -> {
                            return Instant.parse(dateString)
                                    .atZone(ZoneId.systemDefault())
                                    .toLocalDateTime();
                        }
                    }
                    return LocalDateTime.parse(dateString,
                            DateTimeFormatter.ofPattern(pattern));
                } catch (DateTimeParseException ignored) {
                }
            }

            // 如果所有格式都解析失败，抛出异常
            throw new DateTimeParseException(
                    "Cannot parse date time: " + dateString, dateString, 0);
        }
    }

    public class MultiFormatLocalTimeDeserializer extends JsonDeserializer<LocalTime> {
        private static final List<DateTimeFormatter> FORMATTERS = Arrays.asList(
                DateTimeFormatter.ofPattern("HH:mm:ss"),
                DateTimeFormatter.ofPattern("HH:mm"),
                DateTimeFormatter.ofPattern("H:mm"),
                DateTimeFormatter.ISO_LOCAL_TIME
        );

        @Override
        public LocalTime deserialize(JsonParser p, DeserializationContext ctxt) throws IOException {
            String timeStr = p.getText().trim();

            for (DateTimeFormatter formatter : FORMATTERS) {
                try {
                    return LocalTime.parse(timeStr, formatter);
                } catch (DateTimeParseException e) {
                    continue;
                }
            }
            throw new JsonParseException(p, "Cannot parse time value: " + timeStr);
        }
    }

    @Bean
    public Jackson2ObjectMapperBuilderCustomizer jacksonCustomizer() {
        return builder -> {
            builder.deserializerByType(LocalTime.class, new MultiFormatLocalTimeDeserializer());
            // 设置序列化输出格式
            builder.serializers(new LocalTimeSerializer(DateTimeFormatter.ofPattern("HH:mm")));
        };
    }

    @Bean
    public LocalDateTimeSerializer localDateTimeSerializer() {
        return new LocalDateTimeSerializer(DateTimeFormatter.ofPattern(DATE_PATTERNS.get(1)));
    }

    @Bean
    public LocalDateTimeDeserializer localDateTimeDeserializer() {
        return new CustomLocalDateTimeDeserializer();
    }

    @Bean
    public Jackson2ObjectMapperBuilderCustomizer jacksonObjectMapperCustomization() {
        return jacksonObjectMapperBuilder -> {
            jacksonObjectMapperBuilder.timeZone(TimeZone.getTimeZone("GMT+8"))
                    .serializerByType(LocalDateTime.class, localDateTimeSerializer())
                    .deserializerByType(LocalDateTime.class, localDateTimeDeserializer())
                    .failOnEmptyBeans(false)
                    .featuresToEnable(DeserializationFeature.ACCEPT_SINGLE_VALUE_AS_ARRAY, MapperFeature.ACCEPT_CASE_INSENSITIVE_PROPERTIES)
                    .featuresToDisable(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES,
                            SerializationFeature.WRITE_DATES_AS_TIMESTAMPS)
                    .dateFormat(new SimpleDateFormat(DATE_PATTERNS.get(1)));
        };
    }

    @Bean
    public JacksonConverterFactory jsonConverterFactory(ObjectMapper retrofitObjectMapper) {
        return JacksonConverterFactory.create(retrofitObjectMapper);
    }
}
